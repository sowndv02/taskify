@using System.Security.Claims;
@using taskify_font_end.Models.DTO;
﻿@using taskify_utility

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    bool isAdmin = User.IsInRole(SD.Admin);
    var userId = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
    var taskStatistics = ViewBag.taskStatistics as Dictionary<StatusDTO, int>;
    var projectStatistics = ViewBag.projectStatistics as Dictionary<StatusDTO, int>;
    var baseUrl = $"{Context.Request.Scheme}://{Context.Request.Host}{Context.Request.PathBase}";

}
@model taskify_font_end.Models.DTO.WorkspaceDTO
@if (Model == null)
{
    <div class="content-wrapper">
        <div class="container-fluid">
            <div class="card text-center mt-4">
                <div class="card-body">
                    <div class="misc-wrapper">
                        <h2 class="mb-2 mx-2">You don't have any workspaces!</h2>
                        <p class="mb-4 mx-2">
                            Do you want to create a new workspace?
                        </p>
                        <a asp-action="Create" asp-controller="Workspace" class="btn btn-primary">Create</a>
                        <div class="mt-3">
                            <img src="~/image/man-with-laptop-light.png" alt="page-misc-error-light"
                                 width="500" class="img-fluid" data-app-dark-img="illustrations/page-misc-error-dark.png"
                                 data-app-light-img="illustrations/page-misc-error-light.png" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

}
else
{
    <div class="content-wrapper">
        <div class="container-fluid">
            <div class="col-lg-12 col-md-12 order-1">
                <div class="row mt-4">

                    <div class="@(isAdmin ? "col-lg-4" : "col-lg-6") col-md-12 col-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="card-title d-flex align-items-start justify-content-between">
                                    <div class="avatar flex-shrink-0">
                                        <i class="menu-icon tf-icons bx bx-briefcase-alt-2 bx-md text-success"></i>
                                    </div>
                                </div>
                                <span class="fw-semibold d-block mb-1">Total projects</span>
                                <h3 class="card-title mb-2">
                                    @(ViewBag.projects != null ? @ViewBag.projects.Count : "0")
                                </h3>
                                <a asp-action="Index" asp-controller="Project">
                                    <small class="text-success fw-semibold">
                                        <i class="bx bx-right-arrow-alt"></i>View more
                                    </small>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="@(isAdmin ? "col-lg-4" : "col-lg-6")  col-md-12 col-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="card-title d-flex align-items-start justify-content-between">
                                    <div class="avatar flex-shrink-0">
                                        <i class="menu-icon tf-icons bx bx-task bx-md text-primary"></i>
                                    </div>
                                </div>
                                <span class="fw-semibold d-block mb-1">Total tasks</span>
                                <h3 class="card-title mb-2"> @(ViewBag.tasks != null ? @ViewBag.tasks.Count : "0")</h3>
                                <a asp-action="Index" asp-controller="Task">
                                    <small class="text-primary fw-semibold">
                                        <i class="bx bx-right-arrow-alt"></i>View more
                                    </small>
                                </a>
                            </div>
                        </div>
                    </div>
                    @if (isAdmin)
                    {
                        <div class="@(isAdmin ? "col-lg-4" : "col-lg-6")  col-md-12 col-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="card-title d-flex align-items-start justify-content-between">
                                        <div class="avatar flex-shrink-0">
                                            <i class="menu-icon tf-icons bx bxs-user-detail bx-md text-warning"></i>
                                        </div>
                                    </div>
                                    <span class="fw-semibold d-block mb-1">Total users</span>
                                    <h3 class="card-title mb-2">
                                        6
                                    </h3>
                                    <a asp-action="Index" asp-controller="User">
                                        <small class="text-warning fw-semibold">
                                            <i class="bx bx-right-arrow-alt"></i>View more
                                        </small>
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>


                <div class="row">
                    <div class="col-md-6 col-lg-4 col-xl-4 order-0 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex align-items-center justify-content-between pt-3 pb-1">
                                <div class="card-title mb-0">
                                    <h5 class="m-0 me-2">Project statistics</h5>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">

                                    <div id="projectStatisticsChart"></div>
                                </div>
                                <ul class="p-0 m-0">
                                    @if (projectStatistics != null)
                                    {
                                        @foreach (var kvp in projectStatistics)
                                        {
                                            <li class="d-flex mb-4 pb-1">
                                                <div class="avatar flex-shrink-0 me-3">
                                                    <span class="avatar-initial rounded bg-label-primary">
                                                        <i class="bx bx-briefcase-alt-2 text-@kvp.Key.Color?.Title"></i>
                                                    </span>
                                                </div>
                                                <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                                    <div class="me-2">
                                                        <span>
                                                            <h6 class="mb-0">@kvp.Key.Title</h6>
                                                        </span>
                                                    </div>
                                                    <div class="user-progress">
                                                        <small class="fw-semibold">@kvp.Value</small>
                                                    </div>
                                                </div>
                                            </li>
                                        }
                                        <li class="d-flex mb-4 pb-1">
                                            <div class="avatar flex-shrink-0 me-3">
                                                <span class="avatar-initial rounded bg-label-primary">
                                                    <i class="bx bx-menu"></i>
                                                </span>
                                            </div>
                                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                                <div class="me-2">
                                                    <h5 class="mb-0">Total</h5>
                                                </div>
                                                <div class="user-progress">
                                                    <div class="status-count">
                                                        <h5 class="mb-0">@(@ViewBag.projects != null ? @ViewBag.projects.Count : "0")</h5>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4 col-xl-4 order-0 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex align-items-center justify-content-between pt-3 pb-1">
                                <div class="card-title mb-0">
                                    <h5 class="m-0 me-2">Task statistics</h5>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div id="taskStatisticsChart"></div>
                                </div>
                                <ul class="p-0 m-0">
                                    @if (taskStatistics != null)
                                    {
                                        @foreach (var kvp in taskStatistics)
                                        {
                                            <li class="d-flex mb-4 pb-1">
                                                <div class="avatar flex-shrink-0 me-3">
                                                    <span class="avatar-initial rounded bg-label-primary">
                                                        <i class="bx bx-briefcase-alt-2 text-@kvp.Key.Color?.Title"></i>
                                                    </span>
                                                </div>
                                                <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                                    <div class="me-2">
                                                        <span>
                                                            <h6 class="mb-0">@kvp.Key.Title</h6>
                                                        </span>
                                                    </div>
                                                    <div class="user-progress">
                                                        <small class="fw-semibold">@kvp.Value</small>
                                                    </div>
                                                </div>
                                            </li>
                                        }
                                        <li class="d-flex mb-4 pb-1">
                                            <div class="avatar flex-shrink-0 me-3">
                                                <span class="avatar-initial rounded bg-label-primary">
                                                    <i class="bx bx-menu"></i>
                                                </span>
                                            </div>
                                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                                <div class="me-2">
                                                    <h5 class="mb-0">Total</h5>
                                                </div>
                                                <div class="user-progress">
                                                    <div class="status-count">
                                                        <h5 class="mb-0">@(@ViewBag.tasks != null ? @ViewBag.tasks.Count : "0")</h5>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4 order-2 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between pt-3 pb-0">
                                <h5 class="card-title m-0 me-2">Todos overview</h5>
                                <div>
                                    <span data-bs-toggle="modal" data-bs-target="#create_todo_modal">
                                        <a href="javascript:void(0);" class="btn btn-sm btn-primary"
                                           data-bs-toggle="tooltip" data-bs-placement="left"
                                           data-bs-original-title="Create todo">
                                            <i class='bx bx-plus'></i>
                                        </a>
                                    </span>
                                    <a asp-action="Index" asp-controller="Todo">
                                        <button type="button"
                                                class="btn btn-sm btn-primary" data-bs-toggle="tooltip" data-bs-placement="right"
                                                data-bs-original-title="View more">
                                            <i class="bx bx-list-ul"></i>
                                        </button>
                                    </a>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div id="todoStatisticsChart"></div>
                                </div>
                                <ul class="p-0 m-0">
                                    @if(ViewBag.todos != null)
                                    {
                                        @foreach(var item in ViewBag.todos)
                                        {
                                            <li class="d-flex mb-4 pb-1">
                                                <div class="avatar flex-shrink-0">
                                                    <input type="checkbox" @(item.Status ? "checked" : "") id="@item.Id"
                                                           data-url="@baseUrl/Todo/ChangeStatus"
                                                           data-userId="@userId"
                                                           onclick='update_status(this)'
                                                           name="@item.Id" class="form-check-input mt-0">
                                                </div>
                                                <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                                    <div class="me-2">
                                                        <h6 class="m-0 @(item.Status ? "striked": "")"
                                                            id="@item.Id'_title'">
                                                            @item.Title
                                                        </h6>
                                                        <small class="text-muted d-block mb-1">@item.CreatedDate?.ToString("yyyy-MM-dd HH:mm:ss")</small>
                                                    </div>
                                                </div>
                                            </li>
                                        }
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <div class="nav-align-top my-4">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <button type="button" class="nav-link active" role="tab" data-bs-toggle="tab"
                                data-bs-target="#navs-top-projects" aria-controls="navs-top-projects"
                                aria-selected="true">
                            <i class="menu-icon tf-icons bx bx-briefcase-alt-2 text-success"></i>Projects
                        </button>
                    </li>
                    <li class="nav-item">
                        <button type="button" class="nav-link" role="tab" data-bs-toggle="tab"
                                data-bs-target="#navs-top-tasks" aria-controls="navs-top-tasks" aria-selected="false">
                            <i class="menu-icon tf-icons bx bx-task text-primary"></i>Tasks
                        </button>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade active show" id="navs-top-projects" role="tabpanel">

                        <div class="">

                            <div class="d-flex justify-content-between">
                                <h4 class="fw-bold">
                                    @User.Identity.Name 
                                    Projects
                                </h4>
                            </div>
                            <!-- projects card -->
                            <div class="">
                                <div>

                                    <div class="">
                                        <table data-mobile-responsive="true" data-route-prefix="/Project" id="table" class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Id</th>
                                                    <th>Title</th>
                                                    <th>User</th>
                                                    <th>StartAt</th>
                                                    <th>EndAt</th>
                                                    <th>Actual EndAt</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tableBody">
                                                @if (ViewBag.projects != null && ViewBag.projects.Count > 0)
                                                {
                                                    @foreach (var item in ViewBag.projects)
                                                    {
                                                        <tr>
                                                            <td>@item.Id</td>
                                                            <td>
                                                                <a asp-action="Detail" asp-controller="Project" asp-route-id="@item.Id" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom" title="@item.Title"><strong>@item.Title</strong></a>
                                                            </td>
                                                            <td>
                                                                <ul class="list-unstyled users-list m-0 avatar-group d-flex align-items-center">
                                                                    @foreach(var user in item.ProjectUsers)
                                                                    {
                                                                        <li><a asp-action="Profile" asp-controller="User" asp-route-id="@user.User?.Id" target="_blank"></a></li>
                                                                        <li class="avatar avatar-sm pull-up" title="@user.User?.FirstName @user.User?.LastName">
                                                                            <a asp-action="Profile" asp-controller="User" asp-route-id="@user.User?.Id" target="_blank">
                                                                                <img src="@user.User?.ImageUrl" class="rounded-circle">
                                                                            </a>
                                                                        </li>
                                                                    }
                                                                </ul>
                                                            </td>
                                                            <td>@item.StartAt.ToShortDateString()</td>
                                                            <td>@item.EndAt.ToShortDateString()</td>
                                                            <td>@item.ActualEndAt?.ToShortDateString()</td>
                                                            <td>
                                                                @if (userId.Equals(item.OwnerId))
                                                                {
                                                                    <a asp-action="Update" asp-controller="Project" asp-route-id="@item.Id" title="Update"><i class="bx bx-edit mx-1"></i></a>
                                                                    <button title="Delete" type="button" class="btn delete-item" data-id="@item.Id" data-type="Project">
                                                                        <i class="bx bx-trash text-danger"></i>
                                                                    </button>
                                                                    <button class="duplicate-item btn" data-id="@item.Id" data-type="Project"><i class='menu-icon tf-icons bx bx-copy text-warning'></i></button>

                                                                }
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <script>
                                var label_update = '
                                                                                                                    Update ';
                                var label_delete = '
                                                                                                                    Delete ';
                                var label_not_assigned = '
                                                                                                                    Not assigned ';
                                var add_favorite = '
                                                                                                                    Click to mark as favorite ';
                                var remove_favorite = '
                                                                                                                    Click to remove from favorite ';
                                var label_duplicate = '
                                                                                                                    Duplicate ';

                            </script>
                            <script src="~/js/project-list.js"></script>
                        </div>

                    </div>

                    <div class="tab-pane fade "
                         id="navs-top-tasks" role="tabpanel">

                        <div class="">

                            <div class="d-flex justify-content-between">
                                <h4 class="fw-bold">@User.Identity.Name Tasks                                    </h4>
                            </div>
                            <!-- tasks -->
                            <div class="">
                                <div>

                                    <div class="">
                                        <table data-mobile-responsive="true" data-route-prefix="/Task" id="table" class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Id</th>
                                                    <th>Task</th>
                                                    <th>Project</th>
                                                    <th>Users</th>
                                                    <th>StartAt</th>
                                                    <th>EndAt</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tableBody">
                                                @if (ViewBag.tasks != null && ViewBag.tasks.Count > 0)
                                                {
                                                    @foreach (var item in ViewBag.tasks)
                                                    {
                                                        <tr>
                                                            <td>@item.Id</td>
                                                            <td><a asp-action="Detail" asp-controller="Task" asp-route-id="@item.Id" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom" title="@item.Title"><strong>@item.Title</strong></a></td>
                                                            <td><a asp-action="Detail" asp-controller="Project" asp-route-id="@item.ProjectId" target="_blank data-bs-toggle=" tooltip'="" data-bs-placement="bottom" title="New" website="" to="" work="" on=""><strong>@item.Project?.Title</strong></a></td>
                                                            <td>
                                                                <ul class="list-unstyled users-list m-0 avatar-group d-flex align-items-center">
                                                                    @foreach (var user in item.TaskUsers)
                                                                    {
                                                                        <li><a asp-action="Profile" asp-controller="User" asp-route-id="@user.User?.Id" target="_blank"></a></li>
                                                                        <li class="avatar avatar-sm pull-up" title="@user.User?.FirstName @user.User?.LastName">
                                                                            <a asp-action="Profile" asp-controller="User" asp-route-id="@user.User?.Id" target="_blank">
                                                                                <img src="@user.User?.ImageUrl" class="rounded-circle">
                                                                            </a>
                                                                        </li>
                                                                    }
                                                                </ul>
                                                            </td>
                                                            <td>@item.StartAt.ToShortDateString()</td>
                                                            <td>@item.EndAt.ToShortDateString()</td>
                                                            <td><span class="badge bg-label-@item.Status?.Color?.Title me-1">@item.Status?.Title</span></td>
                                                            <td>
                                                                <a asp-action="Update" asp-controller="Task" asp-route-id="@item.Id" title="Update"><i class="bx bx-edit mx-1"></i></a>
                                                                @if (userId.Equals(item.OwnerId))
                                                                {

                                                                    <button title="Delete" type="button" class="btn delete-item" data-id="@item.Id" data-type="Task">
                                                                        <i class="bx bx-trash text-danger"></i>
                                                                    </button>
                                                                }
                                                                <button class="duplicate-item btn" data-id="@item.Id" data-type="Task"><i class='menu-icon tf-icons bx bx-copy text-warning'></i></button>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>

                                    </div>
                                </div>
                            </div>


                            <script>
                                var label_update = 'Update ';
                                var label_delete = 'Delete ';
                                var label_duplicate = 'Duplicate ';
                                var label_not_assigned = 'Not assigned ';
                                var add_favorite = 'Click to mark as favorite ';
                                var remove_favorite = 'Click to remove from favorite ';
                                var id = '';
                            </script>
                            <script src="~/js/task.js"></script>
                        </div>

                    </div>

                </div>
            </div>
            <!-- ------------------------------------------- -->
        </div>
        <script>
            var labels = ['Default', 'STARTED', 'ON GOING', 'IN REVIEW'];
            var project_data = [2, 4, 5, 2];
            var task_data = [3, 7, 20, 18];
            var bg_colors = ['#6777ef', '#ff3300', '#3333cc', '#ff00ff'];
            var total_projects = [13];
            var total_tasks = [48];
            var total_todos = [5];
            var todo_data = [3, 2];
            //labels
            var done = 'Done ';
            var pending = 'Pending ';
            var total = 'Total ';
        </script>
        <script src="~/js/apexcharts.js"></script><script src="~/js/dashboard.js"></script>

        <script>
            var label_please_wait = 'Please wait...';
            var label_please_select_records_to_delete = 'Please select records to delete.';
            var label_something_went_wrong = 'Something went wrong.';
            var label_please_correct_errors = 'Please correct errors.';
            var label_project_removed_from_favorite_successfully = 'Project removed from favorite successfully.';
            var label_project_marked_as_favorite_successfully = 'Project marked as favorite successfully.';
            var label_yes = 'Yes';
            var label_upload = 'Upload';

            $(document).ready(function () {
                $('#table').DataTable();
            });


            $(document).ready(function () {
                $(document).on('click', '.delete-item', function (e) {
                    e.preventDefault();
                    var id = $(this).data('id');
                    var type = $(this).data('type');
                    var reload = $(this).data('reload');
                    var tableID = $(this).data('table') || 'table';

                    // Show delete confirmation modal
                    $('#deleteModal').modal('show');

                    // Handle click on confirm delete button in modal
                    $('#confirmDeleteBtn').off('click').on('click', function () {
                        // Disable button and show loading state
                        $(this).html('Deleting...').attr('disabled', true);

                        // Construct URL and AJAX request dynamically
                        var urlPrefix = window.location.pathname.split('/')[1];
                        var url = `/${type}/Delete/${id}`;

                        $.ajax({
                            url: url,
                            type: 'DELETE',
                            success: function (response) {
                                $('#deleteModal').modal('hide');
                                if (response.error === false) {
                                    toastr.success(response.message);
                                    setTimeout(function () {
                                        window.location.reload();
                                    }, 2000); // Optional delay before reload
                                } else {
                                    toastr.error(response.message);
                                }
                            },
                            error: function (xhr, status, error) {
                                $('#deleteModal').modal('hide');
                                toastr.error('Failed to delete item: ' + error);
                            },
                            complete: function () {
                                $('#confirmDeleteBtn').html('Delete').attr('disabled', false);
                            }
                        });
                    });
                });

                $(document).on('click', '.duplicate-item', function (e) {
                    e.preventDefault();
                    var id = $(this).data('id');
                    var type = $(this).data('type');
                    var reload = $(this).data('reload');
                    var tableID = $(this).data('table') || 'table';

                    // Show duplicate confirmation modal
                    $('#duplicateModal').modal('show');

                    // Handle click on confirm duplicate button in modal
                    $('#confirmDuplicateBtn').off('click').on('click', function () {
                        // Disable button and show loading state
                        $(this).html('Duplicating...').attr('disabled', true);

                        // Construct URL and AJAX request dynamically
                        var url = `/${type}/Duplicate/${id}`;

                        $.ajax({
                            url: url,
                            type: 'POST',
                            success: function (response) {
                                $('#duplicateModal').modal('hide');
                                if (response.error === false) {
                                    toastr.success(response.message);
                                    setTimeout(function () {
                                        window.location.reload();
                                    }, 2000); // Optional delay before reload
                                } else {
                                    toastr.error(response.message);
                                }
                            },
                            error: function (xhr, status, error) {
                                $('#duplicateModal').modal('hide');
                                toastr.error('Failed to duplicate item: ' + error);
                            },
                            complete: function () {
                                $('#confirmDuplicateBtn').html('Duplicate').attr('disabled', false);
                            }
                        });
                    });
                });

            });

        </script>
    </div>
}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this item?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="duplicateModal" tabindex="-1" aria-labelledby="duplicateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="duplicateModalLabel">Confirm Duplication</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to duplicate this item?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmDuplicateBtn">Duplicate</button>
            </div>
        </div>
    </div>
</div>

   
@{ 
    <partial name="_ValidationScriptsPartial" />
}
